<!DOCTYPE html>
<html>
<head>
  <title>맛집 추천</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #map {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 400px;
      box-sizing: border-box;
    }
    #searchInput {
      width: 70%;
      padding: 8px;
      margin: 0 5px 0 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      padding: 8px 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #45a049;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 10px 0;
      text-align: center;
    }
    .bar-container {
      width: 100%;
      max-width: 200px;
      margin: 8px 0;
    }
    .bar {
      position: relative;
      height: 18px;
      background-color: #e0e0e0; /* 100% 배경 회색 */
      border-radius: 2px;
      overflow: hidden;
    }
    .bar-segment {
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      color: white;
      text-align: right;
      padding-right: 5px;
      box-sizing: border-box;
    }
    .revisit-bar {
      position: relative;
      height: 18px;
      background-color: #e0e0e0; /* 100% 배경 회색 */
      border-radius: 2px;
      overflow: hidden;
    }
    .revisit-segment {
      height: 100%;
      position: absolute;
      top: 0;
      color: white;
      text-align: right;
      padding-right: 5px;
      box-sizing: border-box;
    }
    .bar-label {
      font-size: 12px;
      margin-bottom: 2px;
    }
    @media (max-width: 600px) {
      .controls {
        top: 5px;
        padding: 8px;
      }
      #searchInput {
        width: 65%;
        font-size: 12px;
        padding: 6px;
      }
      button {
        font-size: 12px;
        padding: 6px 10px;
      }
      h1 {
        font-size: 16px;
      }
      .bar-container {
        max-width: 100%;
      }
      .bar, .revisit-bar, .bar-segment, .revisit-segment {
        height: 16px;
      }
      .bar-label {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
    <div class="controls">
      <h1>맛집 추천</h1>
      <input type="text" id="searchInput" placeholder="식당 이름 검색">
      <button onclick="searchRestaurant()">검색</button>
    </div>
    <div id="map"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2cf3YWzGrwU9WXlKGVVLFi73cnZ99Cd0&callback=initMap" async defer></script>
  <script>
    let map;
    let restaurants = [
      { name: "고기집", lat: 37.5172, lng: 127.0473, likeProbability: 92, revisitIntent: 90, revisitRate: { "1": 30, "2": 30, "3+": 20 } },
      { name: "파스타 맛집", lat: 37.5200, lng: 127.0450, likeProbability: 87, revisitIntent: 85, revisitRate: { "1": 30, "2": 20, "3+": 20 } },
      { name: "카페 드림", lat: 37.5150, lng: 127.0500, likeProbability: 94, revisitIntent: 95, revisitRate: { "1": 25, "2": 30, "3+": 30 } },
      { name: "분식 천국", lat: 37.5180, lng: 127.0400, likeProbability: 82, revisitIntent: 80, revisitRate: { "1": 35, "2": 20, "3+": 10 } },
      { name: "초밥 왕", lat: 37.5140, lng: 127.0480, likeProbability: 89, revisitIntent: 88, revisitRate: { "1": 30, "2": 25, "3+": 20 } },
    ];

    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            setupMap(userLocation);
          },
          (error) => {
            console.error("위치 정보를 가져오지 못했습니다:", error);
            const defaultLocation = { lat: 37.5172, lng: 127.0473 };
            setupMap(defaultLocation);
            alert("위치 정보를 가져오지 못해 강남역을 기본 위치로 설정했습니다.");
          }
        );
      } else {
        const defaultLocation = { lat: 37.5172, lng: 127.0473 };
        setupMap(defaultLocation);
        alert("이 브라우저는 위치 정보를 지원하지 않습니다. 강남역을 기본 위치로 설정했습니다.");
      }
    }

    function setupMap(center) {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: center,
      });

      new google.maps.Marker({
        position: center,
        map: map,
        title: "내 위치",
        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
      });

      restaurants.forEach(restaurant => {
        const totalRevisitRate = restaurant.revisitRate["1"] + restaurant.revisitRate["2"] + restaurant.revisitRate["3+"];
        const markerColor = totalRevisitRate >= 80 ? "http://maps.google.com/mapfiles/ms/icons/green-dot.png" :
                          totalRevisitRate <= 60 ? "http://maps.google.com/mapfiles/ms/icons/red-dot.png" :
                          "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
        const marker = new google.maps.Marker({
          position: { lat: restaurant.lat, lng: restaurant.lng },
          map: map,
          title: restaurant.name,
          icon: markerColor,
        });

        const infoWindow = new google.maps.InfoWindow();
        const content = `
          <div>
            <b>${restaurant.name}</b><br>
            
            <div class="bar-container">
              <div class="bar-label">재방문 의사 (${restaurant.revisitIntent}%)</div>
              <div class="bar">
                <div class="bar-segment" style="width: ${restaurant.revisitIntent}%; background-color: #4CAF50;">${restaurant.revisitIntent}%</div>
              </div>
            </div>

            <div class="bar-container">
              <div class="bar-label">재방문율 (총 ${totalRevisitRate}%)</div>
              <div class="revisit-bar">
                <div class="revisit-segment" style="width: ${restaurant.revisitRate["1"]}%; left: 0; background-color: #2196F3;">${restaurant.revisitRate["1"]}%</div>
                <div class="revisit-segment" style="width: ${restaurant.revisitRate["2"]}%; left: ${restaurant.revisitRate["1"]}%; background-color: #1976D2;">${restaurant.revisitRate["2"]}%</div>
                <div class="revisit-segment" style="width: ${restaurant.revisitRate["3+"]}%; left: ${restaurant.revisitRate["1"] + restaurant.revisitRate["2"]}%; background-color: #0D47A1;">${restaurant.revisitRate["3+"]}%</div>
              </div>
            </div>

            <div class="bar-container">
              <div class="bar-label">좋아할 확률 (${restaurant.likeProbability}%)</div>
              <div class="bar">
                <div class="bar-segment" style="width: ${restaurant.likeProbability}%; background-color: #FF5722;">${restaurant.likeProbability}%</div>
              </div>
            </div>

            <div>
              <label>재방문 의사:</label>
              <select id="revisitIntent_${restaurant.name}" onchange="updateRevisit(this, '${restaurant.name}')">
                <option value="아직방문안함">아직방문안함</option>
                <option value="X">X</option>
                <option value="O">O</option>
              </select>
            </div>
            <div id="revisitCount_${restaurant.name}" style="display: none;">
              <label>재방문 횟수:</label>
              <select id="revisitCountSelect_${restaurant.name}">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3+">3+</option>
              </select>
            </div>
          </div>
        `;
        infoWindow.setContent(content);
        marker.addListener("click", () => infoWindow.open(map, marker));
      });
    }

    function updateRevisit(select, restaurantName) {
      const revisitCountDiv = document.getElementById(`revisitCount_${restaurantName}`);
      if (select.value === "O") {
        revisitCountDiv.style.display = "block";
      } else {
        revisitCountDiv.style.display = "none";
      }
    }

    function searchRestaurant() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const found = restaurants.find(r => r.name.toLowerCase().includes(input));
      if (found) {
        map.setCenter({ lat: found.lat, lng: found.lng });
        map.setZoom(16);
        alert(`${found.name} 찾았어요!`);
      } else {
        alert("검색 결과가 없어요.");
      }
    }
  </script>
</body>
</html>